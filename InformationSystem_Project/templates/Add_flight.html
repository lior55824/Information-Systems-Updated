<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add Flight | Admin | FLYTAU</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <h1 style="margin:0;">Add Flight</h1>
      <p style="margin:6px 0 0;">Create a new flight only if a suitable plane and sufficient qualified crew are available.</p>
    </div>
  </header>

  <main class="page">
    <div class="page-inner">

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="alerts">
            {% for category, msg in messages %}
              <div class="alert {{ category }}">{{ msg }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <section class="card">
        <h2>Flight Basics</h2>

        <form method="POST" action="{{ url_for('admin_add_flight') }}" class="form">
          <input type="hidden" name="action" value="check">

          <div class="form-row">
            <label for="origin_airport">Origin Airport</label>
            <input id="origin_airport" name="origin_airport" type="text" required
                   value="{{ form.origin_airport if form else '' }}">
          </div>

          <div class="form-row">
            <label for="destination_airport">Destination Airport</label>
            <input id="destination_airport" name="destination_airport" type="text" required
                   value="{{ form.destination_airport if form else '' }}">
          </div>

          <div class="form-row">
            <label for="departure_date">Departure Date</label>
            <input id="departure_date" name="departure_date" type="date" required
                   value="{{ form.departure_date if form else '' }}">
          </div>

          <div class="form-row">
            <label for="departure_time">Departure Time</label>
            <input id="departure_time" name="departure_time" type="time" required
                   value="{{ form.departure_time if form else '' }}">
          </div>

          <div class="form-row">
            <label for="duration">Duration (HH:MM:SS)</label>
            <input id="duration" name="duration" type="text" placeholder="06:30:00" required
                   value="{{ form.duration if form else '' }}">
          </div>

          <div class="form-row">
            <label for="economy_price">Economy Price</label>
            <input id="economy_price" name="economy_price" type="number" step="0.01" min="0.01" required
                   value="{{ form.economy_price if form else '' }}">
          </div>

          <div class="form-row">
            <label for="business_price">Business Price</label>
            <input id="business_price" name="business_price" type="number" step="0.01" min="0.01" required
                   value="{{ form.business_price if form else '' }}">
          </div>

          <button type="submit" class="btn btn-primary">Check Availability</button>
          <a class="btn btn-secondary" href="{{ url_for('admin_dashboard') }}">Back</a>
        </form>
      </section>

      {% if checked %}

        <section class="card">
          <h2>Availability Results</h2>
          <p class="muted">
            Flight type: <strong>{{ flight_type }}</strong>
            | Required crew: <strong>{{ pilots_required }}</strong> pilots, <strong>{{ attendants_required }}</strong> attendants
          </p>

          {% if not planes or planes|length == 0 %}
            <p class="muted">No suitable planes available for the selected date/time and flight type.</p>
          {% endif %}

          {% if pilots|length < pilots_required %}
            <p class="muted">Not enough qualified pilots available (available: {{ pilots|length }}, required: {{ pilots_required }}).</p>
          {% endif %}

          {% if attendants|length < attendants_required %}
            <p class="muted">Not enough qualified attendants available (available: {{ attendants|length }}, required: {{ attendants_required }}).</p>
          {% endif %}
        </section>

        {% if planes and planes|length > 0 and pilots|length >= pilots_required and attendants|length >= attendants_required %}
          <section class="card">
            <h2>Select Plane & Crew</h2>

            <form method="POST" action="{{ url_for('admin_add_flight') }}" class="form">
              <input type="hidden" name="action" value="create">

              <!-- keep basics -->
              <input type="hidden" name="origin_airport" value="{{ form.origin_airport }}">
              <input type="hidden" name="destination_airport" value="{{ form.destination_airport }}">
              <input type="hidden" name="departure_date" value="{{ form.departure_date }}">
              <input type="hidden" name="departure_time" value="{{ form.departure_time }}">
              <input type="hidden" name="duration" value="{{ form.duration }}">
              <input type="hidden" name="economy_price" value="{{ form.economy_price }}">
              <input type="hidden" name="business_price" value="{{ form.business_price }}">

              <div class="form-row">
                <label for="plane_id">Plane</label>
                <select id="plane_id" name="plane_id" required>
                  {% for p in planes %}
                    <option value="{{ p.Plane_ID }}">{{ p.Plane_ID }} ({{ p.Plane_Type }})</option>
                  {% endfor %}
                </select>
              </div>

              <div class="form-row">
                <label for="pilot_ids">Pilots (select {{ pilots_required }})</label>
                <select id="pilot_ids" name="pilot_ids" multiple required>
                  {% for pl in pilots %}
                    <option value="{{ pl.Pilot_ID }}">{{ pl.Pilot_ID }} ({{ pl.Qualification_Level }})</option>
                  {% endfor %}
                </select>
              </div>

              <div class="form-row">
                <label for="attendant_ids">Flight Attendants (select {{ attendants_required }})</label>
                <select id="attendant_ids" name="attendant_ids" multiple required>
                  {% for fa in attendants %}
                    <option value="{{ fa.Attendant_ID }}">{{ fa.Attendant_ID }} ({{ fa.Qualification_Level }})</option>
                  {% endfor %}
                </select>
              </div>

              <button type="submit" class="btn btn-primary">Create Flight</button>
              <a class="btn btn-secondary" href="{{ url_for('admin_add_flight') }}">Start Over</a>
            </form>
          </section>
        {% endif %}

      {% endif %}

    </div>
  </main>
</body>
</html>